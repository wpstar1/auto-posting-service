<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ìë™ í¬ìŠ¤íŒ… ì„œë¹„ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">ğŸš€ ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ</h1>
        <div>
             <span id="user-email" class="text-sm mr-4"></span> <!-- Display user email -->
             <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, <span id="welcome-email"></span>!</h2>
            <p class="text-gray-700">
                ìë™ í¬ìŠ¤íŒ… ì„œë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì›Œë“œí”„ë ˆìŠ¤ ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”.
            </p>
        </div>

        <!-- Quick Post Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">ğŸš€ ë¹ ë¥¸ í¬ìŠ¤íŒ…</h2>
            <form id="quick-post-form">
                <div class="space-y-5">
                    <!-- Keywords Section -->
                    <div>
                        <label for="keyword" class="block text-sm font-medium text-gray-700 mb-1">í¬ìŠ¤íŒ… í‚¤ì›Œë“œ <span class="text-xs text-gray-500">(ì‰¼í‘œ(,)ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥)</span></label>
                        <input id="keyword" name="keyword" placeholder="ì˜ˆ: ê°•ì•„ì§€ ì¢…ë¥˜, ë§›ì§‘ ì¶”ì²œ, ì—¬í–‰ íŒ" class="border border-gray-300 p-3 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>

                    <!-- Content Options Section -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-md font-semibold text-gray-800 mb-3">ê¸€ ë‚´ìš© ì„¤ì •</h3>

                        <!-- Content Writing Style -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì½˜í…ì¸  ì‘ì„± ë°©ì‹</label>
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center">
                                    <input id="contentStrategyAiOnly" name="contentStrategy" type="radio" value="ai_only" checked class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300">
                                    <label for="contentStrategyAiOnly" class="ml-2 block text-sm text-gray-900">AI ìë™ ì‘ì„±</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="contentStrategyMix" name="contentStrategy" type="radio" value="mix" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                    <label for="contentStrategyMix" class="ml-2 block text-sm text-gray-900">ì…ë ¥ ë‚´ìš© + AI</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="contentStrategyUser" name="contentStrategy" type="radio" value="user_only" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="contentStrategyUser" class="ml-2 block text-sm text-gray-900">ì§ì ‘ ì…ë ¥ë§Œ</label>
                                </div>
                            </div>
                        </div>

                        <!-- Content Tone -->
                        <div class="mb-4">
                            <label for="contentTone" class="block text-sm font-medium text-gray-700 mb-1">ê¸€ ë¶„ìœ„ê¸°</label>
                            <select id="contentTone" name="contentTone" class="border border-gray-300 p-2 w-full sm:w-auto rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="default" selected>ê¸°ë³¸ (ì¹œê·¼í•œ ë¸”ë¡œê·¸ì²´)</option>
                                <option value="professional">ì „ë¬¸ì </option>
                                <option value="friendly">ë§¤ìš° ì¹œê·¼í•¨</option>
                                <option value="humorous">ìœ ë¨¸ëŸ¬ìŠ¤</option>
                                <option value="informative">ì •ë³´ ì „ë‹¬</option>
                                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§</option>
                            </select>
                        </div>

                        <!-- User Content Input -->
                        <div>
                            <label for="content" class="block text-sm font-medium text-gray-700 mb-1">ì§ì ‘ ì‘ì„± ë‚´ìš© <span class="text-xs text-gray-500">(ì„ íƒ ì‚¬í•­)</span></label>
                            <textarea id="content" name="content" placeholder="'ì§ì ‘ ì…ë ¥ ë‚´ìš©ë§Œ ì‚¬ìš©' ë˜ëŠ” 'AI ì‘ì„± ì¶”ê°€' ì„ íƒ ì‹œ ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="3" class="border border-gray-300 p-3 w-full rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-md font-semibold text-gray-800 mb-3">ì´ë¯¸ì§€ ì—…ë¡œë“œ <span class="text-xs text-gray-500">(ì„ íƒ ì‚¬í•­)</span></h3>
                        <p class="text-xs text-gray-500 mb-2">ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ëŠ” í¬ìŠ¤íŒ…ì— í•¨ê»˜ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                        
                        <div class="mb-4">
                            <label for="imageUpload" class="cursor-pointer bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium py-2 px-4 border border-gray-300 rounded-md shadow-sm inline-flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
                                <input id="imageUpload" name="imageUpload" type="file" accept="image/*" class="sr-only" onchange="handleImageUpload(event)" multiple>
                            </label>
                        </div>
                        
                        <div id="imagePreviewArea" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 mb-2"></div>
                        <button id="clearImagePreview" type="button" class="hidden text-xs text-red-500 hover:text-red-700 mb-2" onclick="clearImagePreviews()">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ëª¨ë‘ ì§€ìš°ê¸°</button>
                    </div>

                    <!-- Hidden input for image strategy to ensure form works correctly -->
                    <input type="hidden" id="imgStrategyAi" name="imageStrategy" value="ai">

                    <!-- ë°˜ë³µ í¬ìŠ¤íŒ… ì„¹ì…˜ -->
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-md font-semibold text-gray-800 mb-3">í¬ìŠ¤íŒ… ë°˜ë³µ ì„¤ì •</h3>
                        
                        <div class="mb-4">
                            <label for="scheduleInterval" class="block text-sm font-medium text-gray-700 mb-1">ë°˜ë³µ ì£¼ê¸°</label>
                            <select id="scheduleInterval" name="scheduleInterval" class="border border-gray-300 p-2 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="now" selected>ì§€ê¸ˆ í•œ ë²ˆë§Œ í¬ìŠ¤íŒ…</option>
                                <option value="3hourly">3ì‹œê°„ì— 1ë²ˆ</option>
                                <option value="5hourly">5ì‹œê°„ì— 1ë²ˆ</option>
                                <option value="10hourly">10ì‹œê°„ì— 1ë²ˆ</option>
                                <option value="daily">í•˜ë£¨ì— í•œ ë²ˆ</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="enableAllSchedules" name="enableAllSchedules" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enableAllSchedules" class="ml-2 block text-sm text-gray-900">ëª¨ë“  ìŠ¤ì¼€ì¤„ë§ ë°˜ë³µ</label>
                        </div>
                        <p class="text-xs text-gray-500">ë°˜ë³µ ì„¤ì • ì‹œ, í˜„ì¬ ì…ë ¥ëœ í‚¤ì›Œë“œì™€ ì„¤ì •ìœ¼ë¡œ ì£¼ê¸°ë§ˆë‹¤ ìë™ìœ¼ë¡œ í¬ìŠ¤íŒ…í•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="button" id="post-now-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition flex items-center justify-center">
                            <span id="post-button-text">âœ¨ ì§€ê¸ˆ í¬ìŠ¤íŒ…í•˜ê¸°</span>
                            <span id="post-loading-spinner" class="hidden ml-2">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                        
                        <div class="flex justify-center mt-3">
                            <button type="button" id="save-draft-button" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">
                                ì„ì‹œì €ì¥
                            </button>
                        </div>
                    </div>

                    <!-- Post Result Area -->
                    <div id="post-result" class="mt-2 p-3 rounded text-sm text-gray-600 hidden">
                        <p id="post-result-message" class="text-center mb-3 font-medium"></p>
                        <div id="post-result-details" class="bg-gray-50 p-3 rounded-md"></div>
                    </div>
                </div>
            </form>
        </div>

        <!-- WordPress Settings Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">ì›Œë“œí”„ë ˆìŠ¤ ì„¤ì •</h2>
            <form id="wp-settings-form">
                <div class="mb-4">
                    <label for="wpUrl" class="block text-gray-700 text-sm font-bold mb-2">ì›Œë“œí”„ë ˆìŠ¤ URL</label>
                    <input type="url" id="wpUrl" name="wpUrl"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                           placeholder="https://your-wordpress-site.com">
                </div>
                 <div class="mb-4">
                    <label for="wpUsername" class="block text-gray-700 text-sm font-bold mb-2">ì›Œë“œí”„ë ˆìŠ¤ ì‚¬ìš©ìëª…</label>
                    <input type="text" id="wpUsername" name="wpUsername"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                           placeholder="WordPress Username">
                </div>
                <div class="mb-6">
                    <label for="wpPassword" class="block text-gray-700 text-sm font-bold mb-2">ì›Œë“œí”„ë ˆìŠ¤ ì•± ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="wpPassword" name="wpPassword"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                           placeholder="ì•± ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì €ì¥ ì‹œ ì•”í˜¸í™”ë©ë‹ˆë‹¤)">
                     <p class="text-xs text-gray-500">ì›Œë“œí”„ë ˆìŠ¤ ê´€ë¦¬ì > ì‚¬ìš©ì > í”„ë¡œí•„ > ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹„ë°€ë²ˆí˜¸ì—ì„œ ìƒì„±í•˜ì„¸ìš”.</p>
                </div>
                <div class="flex items-center justify-end mb-4">
                    <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        ì„¤ì • ì €ì¥
                    </button>
                </div>
                <div id="settings-message" class="text-center text-sm mt-4"></div> <!-- Message area -->
            </form>
        </div>

        <!-- Saved Posts Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4">ì €ì¥ëœ ê¸€ ë° ì˜ˆì•½ ê´€ë¦¬</h2>
            
            <div class="overflow-x-auto">
                <table id="saved-posts-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œëª©/í‚¤ì›Œë“œ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ë¯¸ì§€</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì˜ˆì•½ ì‹œê°„</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="saved-posts-list" class="bg-white divide-y divide-gray-200">
                        <!-- Saved post items will be loaded here -->
                        <tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Post Scheduling Modal (Initially Hidden) -->
        <div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 m-4 max-w-xl max-h-full overflow-auto w-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-medium text-gray-900">ê¸€ ì˜ˆì•½ ì„¤ì •</h3>
                    <button id="close-schedule-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="schedule-post-form">
                    <input type="hidden" id="schedule-post-id">
                    <div class="mb-4">
                        <label for="schedule-date" class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ</label>
                        <input type="date" id="schedule-date" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="schedule-time" class="block text-sm font-medium text-gray-700 mb-2">ì‹œê°„</label>
                        <input type="time" id="schedule-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-schedule-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            ì˜ˆì•½ ì„¤ì •
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const userEmailSpan = document.getElementById('user-email');
            const welcomeEmailSpan = document.getElementById('welcome-email');
            const logoutButton = document.getElementById('logout-button');
            const wpSettingsForm = document.getElementById('wp-settings-form');
            const settingsMessageDiv = document.getElementById('settings-message');
            
            // ë¹ ë¥¸ í¬ìŠ¤íŒ… ê´€ë ¨ ìš”ì†Œ
            const quickPostForm = document.getElementById('quick-post-form');
            const postNowButton = document.getElementById('post-now-button');
            const postButtonText = document.getElementById('post-button-text');
            const postLoadingSpinner = document.getElementById('post-loading-spinner');
            const postResult = document.getElementById('post-result');
            const postResultMessage = document.getElementById('post-result-message');
            const postResultDetails = document.getElementById('post-result-details');

            // --- Authentication Check --- 
            if (!token) {
                console.log('No token found, redirecting to login.');
                window.location.href = '/login.html';
                return;
            }

            // --- ë¹ ë¥¸ í¬ìŠ¤íŒ… ê¸°ëŠ¥ ---
            postNowButton.addEventListener('click', async () => {
                // UI ì—…ë°ì´íŠ¸ - ë¡œë”© ì‹œì‘
                postNowButton.disabled = true;
                postButtonText.classList.add('hidden');
                postLoadingSpinner.classList.remove('hidden');
                postResult.classList.add('hidden');
                
                try {
                    // form ìš”ì†Œë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
                    const keywordElement = document.getElementById('keyword');
                    const contentElement = document.getElementById('content');
                    const contentToneElement = document.getElementById('contentTone');
                    const contentStrategyElement = document.querySelector('input[name="contentStrategy"]:checked');
                    const imageStrategyElement = document.querySelector('input[name="imageStrategy"]:checked');
                    
                    // í•„ìš”í•œ ìš”ì†Œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ë¥˜ ì²˜ë¦¬
                    if (!keywordElement) throw new Error('í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentElement) throw new Error('ë‚´ìš© ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentToneElement) throw new Error('ê¸€ ë¶„ìœ„ê¸° ì„ íƒ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentStrategyElement) throw new Error('ì½˜í…ì¸  ì‘ì„± ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    if (!imageStrategyElement) {
                        // ì´ë¯¸ì§€ ì „ëµì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                        console.warn('ì´ë¯¸ì§€ ì „ëµì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(AI)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    }
                    
                    // í¼ ë°ì´í„° ìˆ˜ì§‘
                    const formData = {
                        keyword: keywordElement.value,
                        content: contentElement.value,
                        contentStrategy: contentStrategyElement.value,
                        contentTone: contentToneElement.value,
                        imageStrategy: imageStrategyElement ? imageStrategyElement.value : 'ai', // ê¸°ë³¸ê°’ ì œê³µ
                        targetPlatform: 'wordpress',
                        scheduleInterval: 'now'
                    };
                    
                    console.log('í¬ìŠ¤íŒ… ë°ì´í„°:', formData);
                    
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (!formData.keyword) {
                        throw new Error('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                    
                    // API ìš”ì²­ ì „ì†¡
                    const response = await fetch('/api/post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    // ì‘ë‹µì´ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê²½ìš°
                    if (!response) {
                        throw new Error('ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'ì„œë²„ ì˜¤ë¥˜' }));
                        throw new Error(errorData.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }
                    
                    // ê²°ê³¼ ì²˜ë¦¬
                    const data = await response.json();
                    if (data.success) {
                        postResultMessage.textContent = 'í¬ìŠ¤íŒ…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        postResultMessage.className = 'text-center mb-3 font-medium text-green-600';
                        
                        // ê²°ê³¼ ìƒì„¸ ì •ë³´ í‘œì‹œ
                        let detailsHTML = `
                            <p class="mb-2"><strong>ì œëª©:</strong> ${data.title || 'ì œëª© ì •ë³´ ì—†ìŒ'}</p>
                            <p class="mb-2"><strong>URL:</strong> <a href="${data.finalPostUrl}" target="_blank" class="text-blue-600 hover:underline">${data.finalPostUrl}</a></p>
                            <p><strong>í¬ìŠ¤íŠ¸ ID:</strong> ${data.postId || 'ì •ë³´ ì—†ìŒ'}</p>
                        `;
                        postResultDetails.innerHTML = detailsHTML;
                        postResult.classList.remove('hidden');
                    } else {
                        throw new Error(data.error || 'í¬ìŠ¤íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('í¬ìŠ¤íŒ… ì˜¤ë¥˜:', error);
                    postResultMessage.textContent = error.message;
                    postResultMessage.className = 'text-center mb-3 font-medium text-red-600';
                    postResult.classList.remove('hidden');
                    postResultDetails.innerHTML = '';
                } finally {
                    // UI ì—…ë°ì´íŠ¸ - ë¡œë”© ì¢…ë£Œ
                    postNowButton.disabled = false;
                    postButtonText.classList.remove('hidden');
                    postLoadingSpinner.classList.add('hidden');
                }
            });

            // --- ì„ì‹œ ì €ì¥ ê¸°ëŠ¥ ---
            const saveDraftButton = document.getElementById('save-draft-button');
            saveDraftButton.addEventListener('click', async () => {
                // UI ì—…ë°ì´íŠ¸ - ë²„íŠ¼ ë¹„í™œì„±í™”
                saveDraftButton.disabled = true;
                saveDraftButton.textContent = 'ì €ì¥ ì¤‘...';
                
                try {
                    // form ìš”ì†Œë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
                    const keywordElement = document.getElementById('keyword');
                    const contentElement = document.getElementById('content');
                    const contentToneElement = document.getElementById('contentTone');
                    const contentStrategyElement = document.querySelector('input[name="contentStrategy"]:checked');
                    const imageStrategyElement = document.querySelector('input[name="imageStrategy"]:checked');
                    
                    // í•„ìš”í•œ ìš”ì†Œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ë¥˜ ì²˜ë¦¬
                    if (!keywordElement) throw new Error('í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentElement) throw new Error('ë‚´ìš© ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentToneElement) throw new Error('ê¸€ ë¶„ìœ„ê¸° ì„ íƒ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (!contentStrategyElement) throw new Error('ì½˜í…ì¸  ì‘ì„± ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    if (!imageStrategyElement) {
                        console.warn('ì´ë¯¸ì§€ ì „ëµì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(AI)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    }
                    
                    // FormData ìƒì„±
                    const formData = new FormData();
                    
                    formData.append('keyword', keywordElement.value);
                    formData.append('content', contentElement.value);
                    formData.append('contentStrategy', contentStrategyElement.value);
                    formData.append('contentTone', contentToneElement.value);
                    formData.append('imageStrategy', imageStrategyElement ? imageStrategyElement.value : 'ai');
                    formData.append('targetPlatform', 'wordpress');
                    formData.append('isDraft', 'true');
                    
                    // ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€
                    if (window.uploadedImages && window.uploadedImages.length > 0) {
                        window.uploadedImages.forEach((fileObj, index) => {
                            if (fileObj && fileObj.file) {
                                formData.append('images', fileObj.file);
                            }
                        });
                    }
                    
                    // ìœ íš¨ì„± ê²€ì‚¬
                    if (!keywordElement.value) {
                        throw new Error('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                    
                    console.log('ì„ì‹œì €ì¥ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');
                    
                    // API ìš”ì²­ ì „ì†¡ (FormDataë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ)
                    const response = await fetch('/api/post/save', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    // ì‘ë‹µ ì²˜ë¦¬
                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('ê¸€ì´ ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // í¼ ì´ˆê¸°í™”
                        keywordElement.value = '';
                        contentElement.value = '';
                        clearImagePreviews();
                        loadSavedPosts(); // ì €ì¥ëœ ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        throw new Error(data.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì„ì‹œì €ì¥ ì˜¤ë¥˜:', error);
                    alert(`ì„ì‹œì €ì¥ ì‹¤íŒ¨: ${error.message}`);
                } finally {
                    // UI ìƒíƒœ ë³µì›
                    saveDraftButton.disabled = false;
                    saveDraftButton.textContent = 'ì„ì‹œì €ì¥';
                }
            });
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
            window.uploadedImages = [];
            
            function handleImageUpload(event) {
                const files = event.target.files;
                const previewArea = document.getElementById('imagePreviewArea');
                const clearButton = document.getElementById('clearImagePreview');
                
                if (files.length > 0) {
                    clearButton.classList.remove('hidden');
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            const imageId = `img-${Date.now()}-${i}`;
                            
                            // ì´ë¯¸ì§€ ê°ì²´ ì €ì¥
                            window.uploadedImages.push({
                                id: imageId,
                                file: file,
                                preview: e.target.result
                            });
                            
                            // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'relative rounded overflow-hidden border border-gray-200';
                            previewDiv.style.paddingBottom = '100%'; // ì •ì‚¬ê°í˜• ë¹„ìœ¨ ìœ ì§€
                            previewDiv.dataset.imageId = imageId;
                            
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" class="absolute inset-0 w-full h-full object-cover" alt="Image Preview">
                                <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs" 
                                    onclick="removeImage('${imageId}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            `;
                            
                            previewArea.appendChild(previewDiv);
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
            }
            
            function removeImage(imageId) {
                // ì´ë¯¸ì§€ ê°ì²´ì—ì„œ ì œê±°
                window.uploadedImages = window.uploadedImages.filter(img => img.id !== imageId);
                
                // í™”ë©´ì—ì„œ ì œê±°
                const previewDiv = document.querySelector(`[data-image-id="${imageId}"]`);
                if (previewDiv) {
                    previewDiv.remove();
                }
                
                // ëª¨ë“  ì´ë¯¸ì§€ê°€ ì œê±°ë˜ì—ˆìœ¼ë©´ ë²„íŠ¼ë„ ìˆ¨ê¹€
                if (window.uploadedImages.length === 0) {
                    document.getElementById('clearImagePreview').classList.add('hidden');
                }
            }
            
            function clearImagePreviews() {
                const previewArea = document.getElementById('imagePreviewArea');
                const clearButton = document.getElementById('clearImagePreview');
                
                previewArea.innerHTML = '';
                window.uploadedImages = [];
                clearButton.classList.add('hidden');
                
                // íŒŒì¼ ì¸í’‹ ì´ˆê¸°í™”
                const fileInput = document.getElementById('imageUpload');
                fileInput.value = '';
            }
            
            // --- ì €ì¥ëœ ê¸€ ê´€ë¦¬ ê¸°ëŠ¥ ---
            const savedPostsList = document.getElementById('saved-posts-list');
            const scheduleModal = document.getElementById('schedule-modal');
            const closeScheduleModalButton = document.getElementById('close-schedule-modal');
            const schedulePostForm = document.getElementById('schedule-post-form');
            const schedulePostIdInput = document.getElementById('schedule-post-id');
            const cancelScheduleButton = document.getElementById('cancel-schedule-button');
            
            // ì €ì¥ëœ ê¸€ ëª©ë¡ ë¡œë“œ
            async function loadSavedPosts() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    }
                    
                    savedPostsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">ê¸€ ë¡œë”© ì¤‘...</td></tr>';
                    
                    // ì„œë²„ì—ì„œ ì €ì¥ëœ ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ
                    console.log('ì €ì¥ëœ ê¸€ ëª©ë¡ ë¡œë“œ ì¤‘...');
                    const response = await fetch('/api/post/saved', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // ì‘ë‹µ ì²˜ë¦¬
                    if (!response.ok) {
                        throw new Error('ì €ì¥ëœ ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    console.log('ì €ì¥ëœ ê¸€ ë°ì´í„°:', data);
                    
                    // ë°ì´í„° ê²€ì¦
                    if (!data || !data.success) {
                        throw new Error(data.message || 'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                    
                    // ê¸€ ëª©ë¡ì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                    const posts = data.posts || [];
                    if (posts.length === 0) {
                        savedPostsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                        return;
                    }
                    
                    // ê¸€ ëª©ë¡ í‘œì‹œ
                    savedPostsList.innerHTML = '';
                    posts.forEach(post => {
                        const row = document.createElement('tr');
                        
                        // ë‚ ì§œ í˜•ì‹ ì„¤ì •
                        const scheduledDate = post.scheduledAt ? new Date(post.scheduledAt) : null;
                        const formattedDate = scheduledDate ? 
                            scheduledDate.toLocaleString('ko-KR') : '-';
                        
                        // ì´ë¯¸ì§€ ì„¬ë„¤ì¼ í‘œì‹œ (ì´ë¯¸ì§€ê°€ ì—†ì„ ìˆ˜ ìˆìŒ)
                        let imagesHTML = '<span class="text-gray-400">ì—†ìŒ</span>';
                        if (post.images && post.images.length > 0) {
                            imagesHTML = `<div class="flex space-x-1">
                                ${post.images.slice(0, 3).map(img => 
                                    `<img src="${img.url || ''}" class="w-8 h-8 object-cover rounded" alt="ì´ë¯¸ì§€">`
                                ).join('')}
                                ${post.images.length > 3 ? `<span class="flex items-center text-xs text-gray-500">+${post.images.length - 3}</span>` : ''}
                            </div>`;
                        }
                        
                        // ìƒíƒœ í‘œì‹œ
                        let statusText = 'ì €ì¥ë¨';
                        let statusClass = 'bg-gray-100 text-gray-800';
                        
                        if (post.published) {
                            statusText = 'ê²Œì‹œë¨';
                            statusClass = 'bg-green-100 text-green-800';
                        } else if (post.scheduledAt) {
                            statusText = 'ì˜ˆì•½ë¨';
                            statusClass = 'bg-blue-100 text-blue-800';
                        }
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${post.keyword || 'ì œëª© ì—†ìŒ'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${imagesHTML}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button data-id="${post._id}" class="edit-post-button text-indigo-600 hover:text-indigo-900">ìˆ˜ì •</button>
                                ${post.published ? '' : `<button data-id="${post._id}" class="schedule-post-button text-blue-600 hover:text-blue-900">ì˜ˆì•½</button>`}
                                ${post.published ? '' : `<button data-id="${post._id}" class="publish-post-button text-green-600 hover:text-green-900">ê²Œì‹œ</button>`}
                                <button data-id="${post._id}" class="delete-post-button text-red-600 hover:text-red-900">ì‚­ì œ</button>
                            </td>
                        `;
                        
                        savedPostsList.appendChild(row);
                    });
                    
                    // í–‰ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    document.querySelectorAll('.edit-post-button').forEach(button => {
                        button.addEventListener('click', () => editPost(button.dataset.id));
                    });
                    
                    document.querySelectorAll('.schedule-post-button').forEach(button => {
                        button.addEventListener('click', () => openScheduleModal(button.dataset.id));
                    });
                    
                    document.querySelectorAll('.publish-post-button').forEach(button => {
                        button.addEventListener('click', () => publishPost(button.dataset.id));
                    });
                    
                    document.querySelectorAll('.delete-post-button').forEach(button => {
                        button.addEventListener('click', () => deletePost(button.dataset.id));
                    });
                } catch (error) {
                    console.error('ì €ì¥ëœ ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (savedPostsList) {
                        savedPostsList.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">ì˜¤ë¥˜: ${error.message}</td></tr>`;
                    }
                }
            }
            
            // ì €ì¥ëœ ê¸€ ìˆ˜ì •
            async function editPost(postId) {
                try {
                    const response = await fetchAPI(`/api/post/${postId}`);
                    
                    if (!response || !response.ok) {
                        throw new Error('ê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.post) {
                        const post = data.post;
                        
                        // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
                        document.getElementById('keyword').value = post.keyword || '';
                        document.getElementById('content').value = post.content || '';
                        
                        // Content strategy ì„ íƒ
                        const contentStrategyValue = post.contentStrategy || 'ai_only';
                        document.querySelector(`input[name="contentStrategy"][value="${contentStrategyValue}"]`).checked = true;
                        
                        // Content tone ì„ íƒ
                        document.getElementById('contentTone').value = post.contentTone || 'default';
                        
                        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        clearImagePreviews(); // ê¸°ì¡´ ì´ë¯¸ì§€ ì´ˆê¸°í™”
                        if (post.images && post.images.length > 0) {
                            const previewArea = document.getElementById('imagePreviewArea');
                            const clearButton = document.getElementById('clearImagePreview');
                            clearButton.classList.remove('hidden');
                            
                            post.images.forEach((image, index) => {
                                const imageId = `server-img-${image._id || index}`;
                                
                                // ì´ë¯¸ì§€ ê°ì²´ ì €ì¥ (ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì´ë¯¸ì§€)
                                window.uploadedImages.push({
                                    id: imageId,
                                    serverId: image._id,
                                    preview: image.url,
                                    isServer: true
                                });
                                
                                // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                                const previewDiv = document.createElement('div');
                                previewDiv.className = 'relative rounded overflow-hidden border border-gray-200';
                                previewDiv.style.paddingBottom = '100%'; // ì •ì‚¬ê°í˜• ë¹„ìœ¨ ìœ ì§€
                                previewDiv.dataset.imageId = imageId;
                                
                                previewDiv.innerHTML = `
                                    <img src="${image.url}" class="absolute inset-0 w-full h-full object-cover" alt="Image Preview">
                                    <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs" 
                                        onclick="removeImage('${imageId}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                `;
                                
                                previewArea.appendChild(previewDiv);
                            });
                        }
                        
                        // í¼ì— í¬ìŠ¤íŠ¸ ID ì¶”ê°€ (íˆë“  í•„ë“œë¡œ ì¶”ê°€)
                        if (!document.getElementById('edit-post-id')) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.id = 'edit-post-id';
                            hiddenInput.value = post._id;
                            document.getElementById('quick-post-form').appendChild(hiddenInput);
                        } else {
                            document.getElementById('edit-post-id').value = post._id;
                        }
                        
                        // ì €ì¥ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                        saveDraftButton.textContent = 'ìˆ˜ì • ì €ì¥';
                        
                        // ìŠ¤í¬ë¡¤ì„ í¼ ìœ„ì¹˜ë¡œ
                        document.getElementById('quick-post-form').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        throw new Error(data.message || 'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error('Error loading post for edit:', error);
                    alert(`ê¸€ ìˆ˜ì • ì¤€ë¹„ ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            // ê¸€ ì˜ˆì•½ ëª¨ë‹¬ ì—´ê¸°
            function openScheduleModal(postId) {
                schedulePostIdInput.value = postId;
                
                // ê¸°ë³¸ê°’ìœ¼ë¡œ ë‚´ì¼ ë‚ ì§œ ì„¤ì •
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const dateStr = tomorrow.toISOString().split('T')[0];
                const timeStr = '09:00';
                
                document.getElementById('schedule-date').value = dateStr;
                document.getElementById('schedule-time').value = timeStr;
                
                scheduleModal.classList.remove('hidden');
            }
            
            // ê¸€ ì˜ˆì•½ ëª¨ë‹¬ ë‹«ê¸°
            function closeScheduleModal() {
                scheduleModal.classList.add('hidden');
                schedulePostForm.reset();
            }
            
            // ê¸€ ì˜ˆì•½ ì„¤ì •
            async function schedulePost(e) {
                e.preventDefault();
                
                const postId = schedulePostIdInput.value;
                const scheduleDate = document.getElementById('schedule-date').value;
                const scheduleTime = document.getElementById('schedule-time').value;
                
                if (!scheduleDate || !scheduleTime) {
                    alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ISO í˜•ì‹ì˜ ë‚ ì§œ+ì‹œê°„ ë¬¸ìì—´ ìƒì„±
                const scheduledAt = `${scheduleDate}T${scheduleTime}:00`;
                
                try {
                    const response = await fetchAPI(`/api/post/${postId}/schedule`, {
                        method: 'PUT',
                        body: JSON.stringify({ scheduledAt })
                    });
                    
                    if (!response || !response.ok) {
                        throw new Error('ì˜ˆì•½ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeScheduleModal();
                        loadSavedPosts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error('Error scheduling post:', error);
                    alert(`ì˜ˆì•½ ì„¤ì • ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            // ì €ì¥ëœ ê¸€ ê²Œì‹œí•˜ê¸°
            async function publishPost(postId) {
                if (!confirm('ì´ ê¸€ì„ ì§€ê¸ˆ ê²Œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                try {
                    const response = await fetchAPI(`/api/post/${postId}/publish`, {
                        method: 'PUT'
                    });
                    
                    if (!response || !response.ok) {
                        throw new Error('ê²Œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadSavedPosts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error('Error publishing post:', error);
                    alert(`ê²Œì‹œ ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            // ì €ì¥ëœ ê¸€ ì‚­ì œí•˜ê¸°
            async function deletePost(postId) {
                if (!confirm('ì´ ê¸€ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                try {
                    const response = await fetchAPI(`/api/post/${postId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response || !response.ok) {
                        throw new Error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadSavedPosts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        throw new Error(data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                    alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                }
            }

            // --- Helper: API Fetch Function with Auth Header ---
            async function fetchAPI(url, options = {}) {
                // URLì´ /ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  í•„ìš”í•œ ê²½ìš° ìˆ˜ì •
                if (!url.startsWith('/') && !url.startsWith('http')) {
                    url = '/' + url;
                }
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...(options.headers || {}),
                };
                
                try {
                    console.log(`API ìš”ì²­: ${url}, ë©”ì†Œë“œ: ${options.method || 'GET'}`);
                    const response = await fetch(url, { ...options, headers });
                    console.log(`API ì‘ë‹µ ìƒíƒœ: ${response.status}, ì»¨í…ì¸  íƒ€ì…: ${response.headers.get('content-type')}`);
                    
                    if (response.status === 401) {
                        // Unauthorized (e.g., token expired)
                        localStorage.removeItem('authToken');
                        alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        window.location.href = '/login.html';
                        return null; // Indicate failure
                    }
                    return response;
                } catch (error) {
                    console.error('API Fetch Error:', error);
                    // Handle network errors
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                    return null; // Indicate failure
                }
            }

            // --- Load User Settings --- 
            async function loadUserSettings() {
                console.log('ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì¤‘...');
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    }
                    
                    const response = await fetch('/api/user/settings', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('ì„¤ì •ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    const data = await response.json();
                    console.log('ì„¤ì • ë°ì´í„°:', data);
                    
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        
                        // ì´ë©”ì¼ í‘œì‹œ
                        if (userEmailSpan) userEmailSpan.textContent = settings.email || '';
                        if (welcomeEmailSpan) welcomeEmailSpan.textContent = settings.email || '';
                        
                        // ì›Œë“œí”„ë ˆìŠ¤ ì„¤ì • í¼ ì±„ìš°ê¸°
                        const wpUrlInput = document.getElementById('wpUrl');
                        const wpUsernameInput = document.getElementById('wpUsername');
                        const wpPasswordInput = document.getElementById('wpPassword');
                        
                        if (wpUrlInput) wpUrlInput.value = settings.wpUrl || '';
                        if (wpUsernameInput) wpUsernameInput.value = settings.wpUsername || '';
                        if (wpPasswordInput) {
                            wpPasswordInput.value = '';
                            wpPasswordInput.placeholder = 'ë³€ê²½ì‹œì—ë§Œ ì…ë ¥í•˜ì„¸ìš”';
                        }
                    } else {
                        throw new Error(data.message || 'ì„¤ì • ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                } catch (error) {
                    console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (settingsMessageDiv) {
                        settingsMessageDiv.textContent = `ì„¤ì • ë¡œë”© ì‹¤íŒ¨: ${error.message}`;
                        settingsMessageDiv.className = 'text-center text-sm mt-4 text-red-500';
                    }
                }
            }

            // --- Save User Settings --- 
            async function saveUserSettings(e) {
                e.preventDefault();
                console.log('ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨');
                settingsMessageDiv.textContent = 'ì €ì¥ ì¤‘...';
                settingsMessageDiv.className = 'text-center text-sm mt-4 text-blue-500';

                const wpUrl = document.getElementById('wpUrl').value;
                const wpUsername = document.getElementById('wpUsername').value;
                const wpPassword = document.getElementById('wpPassword').value;

                const updateData = {
                    wpUrl: wpUrl,
                    wpUsername: wpUsername,
                };
                // Only include password if user entered something
                if (wpPassword) {
                    updateData.wpPassword = wpPassword;
                }

                console.log('Saving user settings:', updateData);
                try {
                    // ì§ì ‘ fetchë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ - fetchAPI í•¨ìˆ˜ ìš°íšŒ
                    const response = await fetch('/api/user/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                    
                    if (response.status === 200) {
                        // ì„±ê³µí–ˆë‹¤ê³  ê°„ì£¼
                        settingsMessageDiv.textContent = 'ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                        settingsMessageDiv.className = 'text-center text-sm mt-4 text-green-500';
                        
                        // Clear password field after successful save
                        document.getElementById('wpPassword').value = '';
                        document.getElementById('wpPassword').placeholder = 'ë³€ê²½ì‹œì—ë§Œ ì…ë ¥í•˜ì„¸ìš”';
                        
                        return; // ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë¨
                    }
                    
                    // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•˜ë ¤ê³  ì‹œë„
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            if (data && data.message) {
                                throw new Error(data.message);
                            }
                        }
                    } catch (jsonError) {
                        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', jsonError);
                    }
                    
                    // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
                    throw new Error(`ì„œë²„ ì‘ë‹µ ìƒíƒœ: ${response.status}`);
                } catch (error) {
                    console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                    settingsMessageDiv.textContent = 'ì›Œë“œí”„ë ˆìŠ¤ ì„¤ì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    settingsMessageDiv.className = 'text-center text-sm mt-4 text-red-500';
                }
            }

            // --- Initial Load & Event Listeners --- 
            loadUserSettings(); // Load user settings (like email)
            loadSavedPosts(); // ì €ì¥ëœ ê¸€ ëª©ë¡ ë¡œë“œ

            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    console.log('Token removed from localStorage.');
                    window.location.href = '/login.html';
                });
            }

            if (wpSettingsForm) {
                wpSettingsForm.addEventListener('submit', saveUserSettings);
            }
            
            // ì˜ˆì•½ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            closeScheduleModalButton.addEventListener('click', closeScheduleModal);
            cancelScheduleButton.addEventListener('click', closeScheduleModal);
            schedulePostForm.addEventListener('submit', schedulePost);
        });
    </script>
</body>
</html> 