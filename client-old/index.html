<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìë™í¬ìŠ¤íŒ… ì„œë¹„ìŠ¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> --> <!-- Using CDN script above -->
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <span class="text-xl font-bold text-gray-800">ìë™í¬ìŠ¤íŒ… ì„œë¹„ìŠ¤</span>
        </div>
        <div class="flex items-center space-x-4">
          <a href="register.html" class="text-gray-600 hover:text-gray-900 font-medium">íšŒì›ê°€ì…</a>
          <a href="login.html" class="text-gray-600 hover:text-gray-900 font-medium">ë¡œê·¸ì¸</a>
          <a href="admin.html" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">ê´€ë¦¬ì</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="flex-grow flex items-center justify-center p-4">
    <div class="w-full max-w-2xl bg-white p-8 rounded-lg shadow-md">
      <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ğŸš€ ìë™í¬ìŠ¤íŒ… ì‹œì‘í•˜ê¸°</h1>

      <div class="space-y-6">

        <!-- Keywords Section -->
        <div>
          <label for="keyword" class="block text-sm font-medium text-gray-700 mb-1">í¬ìŠ¤íŒ… í‚¤ì›Œë“œ <span class="text-xs text-gray-500">(ì‰¼í‘œ(,)ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥, í¬ìŠ¤íŒ… ì‹œ ëœë¤ ì„ íƒ)</span></label>
          <input id="keyword" placeholder="ì˜ˆ: ê°•ì•„ì§€ ì¢…ë¥˜, ë§›ì§‘ ì¶”ì²œ, ì—¬í–‰ íŒ" class="border border-gray-300 p-3 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
        </div>

        <!-- Keyword Link Option -->
        <div class="flex items-center space-x-3">
          <input type="checkbox" id="linkKeywordCheckbox" name="linkKeywordCheckbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="toggleKeywordUrlInput()">
          <label for="linkKeywordCheckbox" class="text-sm text-gray-900">í‚¤ì›Œë“œì— ë§í¬ ì¶”ê°€í•˜ê¸°
            <span class="relative group inline-block cursor-help">
              <span class="text-xs text-blue-500">(?)</span>
              <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 w-64 px-3 py-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 z-10 pointer-events-none whitespace-normal">
                ì²´í¬í•˜ë©´ ë³¸ë¬¸ì—ì„œ í‚¤ì›Œë“œê°€ ì²˜ìŒ ë‚˜ì˜¬ ë•Œ ì•„ë˜ URL ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ê±¸ì–´ì¤ë‹ˆë‹¤. (ëœë¤ ì„ íƒëœ í‚¤ì›Œë“œ 1ê°œì— ì ìš©)
              </div>
             </span>
           </label>
          <input type="url" id="keywordLinkUrlInput" name="keywordLinkUrlInput" placeholder="ë§í¬í•  ì „ì²´ URL ì…ë ¥ (ì˜ˆ: https://...)" class="hidden border border-gray-300 p-2 flex-grow rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Content Options Section -->
        <fieldset class="pt-4 border-t border-gray-200">
          <legend class="text-lg font-semibold text-gray-800 mb-3">ê¸€ ë‚´ìš© ì„¤ì •</legend>

          <!-- Content Writing Style -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">ì½˜í…ì¸  ì‘ì„± ë°©ì‹</label>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
              <div class="flex items-center">
                <input id="contentStrategyAiOnly" name="contentStrategy" type="radio" value="ai_only" checked class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300">
                <label for="contentStrategyAiOnly" class="ml-2 block text-sm text-gray-900">AI ìë™ ì‘ì„± <span class="text-xs text-gray-500">(ì…ë ¥ ë‚´ìš© ë¬´ì‹œ)</span></label>
              </div>
              <div class="flex items-center">
                <input id="contentStrategyMix" name="contentStrategy" type="radio" value="mix" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                <label for="contentStrategyMix" class="ml-2 block text-sm text-gray-900">ì…ë ¥ ë‚´ìš© ì•„ë˜ AI ì‘ì„± ì¶”ê°€</label>
              </div>
              <div class="flex items-center">
                <input id="contentStrategyUser" name="contentStrategy" type="radio" value="user_only" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                <label for="contentStrategyUser" class="ml-2 block text-sm text-gray-900">ì§ì ‘ ì…ë ¥ ë‚´ìš©ë§Œ ì‚¬ìš©</label>
              </div>
            </div>
          </div>

          <!-- Content Tone -->
          <div class="mb-4">
              <label for="contentTone" class="block text-sm font-medium text-gray-700 mb-1">ê¸€ ë¶„ìœ„ê¸° <span class="text-xs text-gray-500">(AI ì‘ì„± ì‹œ)</span></label>
              <select id="contentTone" name="contentTone" class="border border-gray-300 p-2 w-full sm:w-auto rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out text-sm">
                  <option value="default" selected>ê¸°ë³¸ (ì¹œê·¼í•œ ë¸”ë¡œê·¸ì²´)</option>
                  <option value="professional">ì „ë¬¸ì </option>
                  <option value="friendly">ë§¤ìš° ì¹œê·¼í•¨</option>
                  <option value="humorous">ìœ ë¨¸ëŸ¬ìŠ¤</option>
                  <option value="informative">ì •ë³´ ì „ë‹¬</option>
                  <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§</option>
              </select>
          </div>

          <!-- Required Phrases -->
          <div class="mb-4">
            <label for="requiredPhrases" class="block text-sm font-medium text-gray-700 mb-1">ë³¸ë¬¸ í•„ìˆ˜ í¬í•¨ ë¬¸êµ¬ <span class="text-xs text-gray-500">(AI ì‘ì„± ì‹œ ëœë¤ ì‚¬ìš©, ì‰¼í‘œë¡œ êµ¬ë¶„)</span></label>
            <input id="requiredPhrases" placeholder="ì˜ˆ: ê¼­ í™•ì¸í•˜ì„¸ìš”!, ì •ë§ ì¶”ì²œí•´ìš”, ë†“ì¹˜ì§€ ë§ˆì„¸ìš”" class="border border-gray-300 p-3 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
             <p class="mt-1 text-xs text-gray-500">AIê°€ ê¸€ì„ ì‘ì„±í•  ë•Œ ì—¬ê¸°ì— ì…ë ¥ëœ ë¬¸êµ¬ ì¤‘ í•˜ë‚˜ë¥¼ ë³¸ë¬¸ì— ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ì‹œí‚µë‹ˆë‹¤.</p>
          </div>

          <!-- User Content Input -->
          <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-1">ì§ì ‘ ì‘ì„± ë‚´ìš© <span class="text-xs text-gray-500">(ì„ íƒ ì‚¬í•­)</span></label>
            <textarea id="content" placeholder="'ì§ì ‘ ì…ë ¥ ë‚´ìš©ë§Œ ì‚¬ìš©' ë˜ëŠ” 'AI ì‘ì„± ì¶”ê°€' ì„ íƒ ì‹œ ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." rows="5" class="border border-gray-300 p-3 w-full rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
          </div>
        </fieldset>

        <!-- Image Options Section -->
        <fieldset class="mt-6 pt-6 border-t border-gray-200">
           <legend class="text-lg font-semibold text-gray-800 mb-3">ì´ë¯¸ì§€ ì„¤ì •</legend>

           <!-- Manual Upload -->
           <div class="mb-4">
             <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¯¸ì§€ ì§ì ‘ ì˜¬ë¦¬ê¸° (ì„ íƒ ì‚¬í•­)</label>
             <div class="flex items-center space-x-3 mb-3">
               <label for="imageUpload" class="cursor-pointer bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium py-2 px-4 border border-gray-300 rounded-md shadow-sm">
                 íŒŒì¼ ì„ íƒ
                 <input id="imageUpload" name="imageUpload" type="file" accept="image/*" class="sr-only" onchange="handleManualUpload(event)" multiple>
               </label>
             </div>
             <div id="imagePreviewArea" class="mt-2 mb-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                 <!-- Image previews will be added here -->
             </div>
             <button id="clearImagePreview" onclick="clearPreview()" class="hidden mt-1 text-xs text-red-500 hover:text-red-700">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ëª¨ë‘ ì§€ìš°ê¸°</button>
           </div>

           <!-- Image Usage Style -->
           <div>
             <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ ì‚¬ìš© ë°©ì‹</label>
              <p class="text-xs text-gray-500 mb-2">AI ë˜ëŠ” Unsplash ì„ íƒ ì‹œ 3ê°œì˜ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ë©°, ê¸€ ë‚´ìš©ê³¼ í•¨ê»˜ ë²ˆê°ˆì•„ í‘œì‹œë©ë‹ˆë‹¤.</p>
             <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0">
                <div class="flex items-center">
                  <input id="imgStrategyAi" name="imageStrategy" type="radio" value="ai" checked class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                  <label for="imgStrategyAi" class="ml-2 block text-sm text-gray-900">AIê°€ ì´ë¯¸ì§€ ìƒì„±</label>
                </div>
                <div class="flex items-center">
                  <input id="imgStrategyUnsplash" name="imageStrategy" type="radio" value="unsplash" class="focus:ring-cyan-500 h-4 w-4 text-cyan-600 border-gray-300">
                  <label for="imgStrategyUnsplash" class="ml-2 block text-sm text-gray-900">Unsplash ë¬´ë£Œ ì´ë¯¸ì§€ ê²€ìƒ‰</label>
                </div>
                <div class="flex items-center">
                  <input id="imgStrategyManual" name="imageStrategy" type="radio" value="manual" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                  <label for="imgStrategyManual" class="ml-2 block text-sm text-gray-900">ì§ì ‘ ì˜¬ë¦° íŒŒì¼ ì‚¬ìš©</label>
                </div>
                <div class="flex items-center">
                   <input id="imgStrategyNone" name="imageStrategy" type="radio" value="none" class="focus:ring-gray-500 h-4 w-4 text-gray-600 border-gray-300">
                   <label for="imgStrategyNone" class="ml-2 block text-sm text-gray-900">ì´ë¯¸ì§€ ì‚¬ìš© ì•ˆ í•¨</label>
                </div>
             </div>
           </div>
        </fieldset>

        <!-- Target Platform Section -->
        <fieldset class="mt-6 pt-6 border-t border-gray-200">
          <legend class="text-lg font-semibold text-gray-800 mb-3">ê¸€ ì˜¬ë¦´ ê³³</legend>
           <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2">
             <div class="flex items-center">
               <input id="platformWp" name="targetPlatform" type="radio" value="wordpress" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
               <label for="platformWp" class="ml-2 block text-sm text-gray-900">ì›Œë“œí”„ë ˆìŠ¤</label>
             </div>
             </div>
        </fieldset>

        <!-- Scheduling Section -->
        <fieldset class="mt-6 pt-6 border-t border-gray-200">
            <legend class="text-lg font-semibold text-gray-800 mb-3">ë°˜ë³µ í¬ìŠ¤íŒ… ì„¤ì •</legend>
            <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <label for="scheduleInterval" class="block text-sm font-medium text-gray-700">ì‹¤í–‰ ì£¼ê¸°:</label>
                <select id="scheduleInterval" name="scheduleInterval" class="border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out text-sm" onchange="updateSubmitButtonText()">
                    <option value="now" selected>ì§€ê¸ˆ ë°”ë¡œ í¬ìŠ¤íŒ…</option>
                    <option value="hourly">1ì‹œê°„ ë§ˆë‹¤</option>
                    <option value="3hourly">3ì‹œê°„ ë§ˆë‹¤</option>
                    <option value="6hourly">6ì‹œê°„ ë§ˆë‹¤</option>
                    <option value="12hourly">12ì‹œê°„ ë§ˆë‹¤</option>
                    <option value="daily">í•˜ë£¨ì— í•œ ë²ˆ</option>
                    <option value="disabled">ë°˜ë³µ ì•ˆ í•¨ (ìˆ˜ë™ìœ¼ë¡œë§Œ)</option>
                </select>
            </div>
            <p class="mt-1 text-xs text-gray-500">ë°˜ë³µ ì„¤ì • ì‹œ, í˜„ì¬ ì…ë ¥ëœ í‚¤ì›Œë“œì™€ ì„¤ì •ìœ¼ë¡œ ì£¼ê¸°ë§ˆë‹¤ ìë™ìœ¼ë¡œ í¬ìŠ¤íŒ…í•©ë‹ˆë‹¤.</p>
        </fieldset>

        <!-- Action Buttons -->
         <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
             <button id="saveSettingsButton" onclick="saveUserSettings()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-75 order-last sm:order-first">
               ğŸ’¾ í˜„ì¬ ì„¤ì • ì €ì¥
             </button>
             <button id="submitButton" onclick="submit()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-75">
               <span id="buttonText">âœ¨ ì§€ê¸ˆ ë°”ë¡œ í¬ìŠ¤íŒ…</span>
               <span id="loadingSpinner" class="hidden ml-2">
                 <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                   <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                   <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                 </svg>
               </span>
             </button>
         </div>
      </div>

      <!-- Result Area -->
      <div id="result" class="mt-6 text-left text-sm text-gray-600 border-t pt-4">
        <p id="resultMessage" class="text-center mb-3 font-medium"></p>
        <!-- Preview section can be added back later if needed -->
      </div>
    </div>
  </div>

  <script>
    let manuallyUploadedFiles = [];

    // Function to load user settings on page load (placeholder)
    async function loadUserSettings() {
        console.log('Loading user settings...');
        const token = localStorage.getItem('authToken');
        if (!token) return; // Not logged in

        try {
            const response = await fetch('/api/user/settings', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                if(response.status === 404) {
                    console.log('No saved settings found for user.');
                    return; // No settings saved yet, do nothing
                }
                throw new Error(`Failed to load settings: ${response.status}`);
            }
            const settings = await response.json();
            console.log('Loaded settings:', settings);

            // Apply loaded settings to the form
            if (settings.keywords && Array.isArray(settings.keywords)) {
                 document.getElementById('keyword').value = settings.keywords.join(', ');
            }
            if (settings.linkKeyword && settings.keywordLinkUrl) {
                 document.getElementById('linkKeywordCheckbox').checked = true;
                 document.getElementById('keywordLinkUrlInput').value = settings.keywordLinkUrl;
                 toggleKeywordUrlInput(); // Show the input field
            } else {
                 document.getElementById('linkKeywordCheckbox').checked = false;
                 toggleKeywordUrlInput(); // Ensure hidden
            }
            if (settings.contentStrategy) {
                const radio = document.querySelector(`input[name="contentStrategy"][value="${settings.contentStrategy}"]`);
                if (radio) radio.checked = true;
            }
            if (settings.contentTone) {
                document.getElementById('contentTone').value = settings.contentTone;
            }
             if (settings.requiredPhrases && Array.isArray(settings.requiredPhrases)) {
                 document.getElementById('requiredPhrases').value = settings.requiredPhrases.join(', ');
            }
            // Content textarea is usually not saved/restored
            if (settings.imageStrategy) {
                 const radio = document.querySelector(`input[name="imageStrategy"][value="${settings.imageStrategy}"]`);
                 if (radio) radio.checked = true;
            }
            if (settings.targetPlatform) {
                 const radio = document.querySelector(`input[name="targetPlatform"][value="${settings.targetPlatform}"]`);
                 if (radio) radio.checked = true;
            }
             if (settings.scheduleInterval) {
                 document.getElementById('scheduleInterval').value = settings.scheduleInterval;
                 updateSubmitButtonText(); // Update button text based on loaded schedule
            }

            console.log('User settings applied to form.');

        } catch (error) {
            console.error('Error loading user settings:', error);
            // Optionally show a message to the user
        }
    }

    // Function to save user settings (placeholder)
    async function saveUserSettings() {
        console.log('Saving user settings...');
        const token = localStorage.getItem('authToken');
        if (!token) {
             document.getElementById('resultMessage').textContent = 'ì˜¤ë¥˜: ì„¤ì •ì„ ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
             return;
        }

        const settingsData = {
            keywords: document.getElementById('keyword').value.split(',').map(k => k.trim()).filter(k => k),
            linkKeyword: document.getElementById('linkKeywordCheckbox').checked,
            keywordLinkUrl: document.getElementById('keywordLinkUrlInput').value,
            contentStrategy: document.querySelector('input[name="contentStrategy"]:checked')?.value || 'ai_only',
            contentTone: document.getElementById('contentTone').value,
            requiredPhrases: document.getElementById('requiredPhrases').value.split(',').map(p => p.trim()).filter(p => p),
            imageStrategy: document.querySelector('input[name="imageStrategy"]:checked')?.value || 'ai',
            targetPlatform: document.querySelector('input[name="targetPlatform"]:checked')?.value || 'wordpress',
            scheduleInterval: document.getElementById('scheduleInterval').value
        };

        const saveButton = document.getElementById('saveSettingsButton');
        const originalButtonText = saveButton.textContent;
        saveButton.disabled = true;
        saveButton.textContent = 'ì €ì¥ ì¤‘...';
        document.getElementById('resultMessage').textContent = '';


        try {
            const response = await fetch('/api/user/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(settingsData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
                throw new Error(errorData.message || `ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${response.status}`);
            }

            const result = await response.json();
            console.log('Save settings result:', result);
            document.getElementById('resultMessage').textContent = 'âœ… ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
            setTimeout(() => { document.getElementById('resultMessage').textContent = ''; }, 3000);


        } catch (error) {
            console.error('Error saving user settings:', error);
             document.getElementById('resultMessage').textContent = `ì˜¤ë¥˜: ${error.message}`;
        } finally {
             saveButton.disabled = false;
             saveButton.textContent = originalButtonText;
        }
    }

    function toggleKeywordUrlInput() {
      const checkbox = document.getElementById('linkKeywordCheckbox');
      const urlInput = document.getElementById('keywordLinkUrlInput');
      urlInput.classList.toggle('hidden', !checkbox.checked);
      if (!checkbox.checked) urlInput.value = '';
    }

    function handleManualUpload(event) {
      const previewArea = document.getElementById('imagePreviewArea');
      const clearButton = document.getElementById('clearImagePreview');
      const manualRadio = document.getElementById('imgStrategyManual');
      const newFiles = Array.from(event.target.files);

      newFiles.forEach(newFile => {
        const isDuplicate = manuallyUploadedFiles.some(f => f.name === newFile.name && f.size === newFile.size);
        if (!isDuplicate) manuallyUploadedFiles.push(newFile);
      });

      renderImagePreviews();
      clearButton.classList.toggle('hidden', manuallyUploadedFiles.length === 0);
      if (manualRadio && manuallyUploadedFiles.length > 0) manualRadio.checked = true;
      event.target.value = null; // Allow re-selecting same file
    }

    function renderImagePreviews() {
      const previewArea = document.getElementById('imagePreviewArea');
      previewArea.innerHTML = '';
      manuallyUploadedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          const div = document.createElement('div');
          div.className = 'relative inline-block border rounded-md overflow-hidden';
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.className = 'h-20 w-auto object-cover';
          const btn = document.createElement('button');
          btn.innerHTML = '&times;';
          btn.className = 'absolute top-0 right-0 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs leading-none hover:bg-red-700 focus:outline-none m-0.5';
          btn.title = `Remove ${file.name}`;
          btn.onclick = () => removeManualImage(index);
          div.appendChild(img);
          div.appendChild(btn);
          previewArea.appendChild(div);
        }
        reader.readAsDataURL(file);
      });
    }

    function removeManualImage(index) {
      manuallyUploadedFiles.splice(index, 1);
      renderImagePreviews();
      if (manuallyUploadedFiles.length === 0) {
        document.getElementById('clearImagePreview').classList.add('hidden');
        // Optionally reset radio if 'manual' was checked and no files remain
         if (document.querySelector('input[name="imageStrategy"]:checked')?.value === 'manual') {
             document.getElementById('imgStrategyAi').checked = true; // Default to AI
         }
      }
    }

    function clearPreview() {
      manuallyUploadedFiles = [];
      renderImagePreviews();
      document.getElementById('clearImagePreview').classList.add('hidden');
      if (document.querySelector('input[name="imageStrategy"]:checked')?.value === 'manual') {
         document.getElementById('imgStrategyAi').checked = true; // Default to AI
      }
    }

     function updateSubmitButtonText() {
         const interval = document.getElementById('scheduleInterval').value;
         const buttonText = document.getElementById('buttonText');
         if (interval === 'now') {
             buttonText.textContent = 'âœ¨ ì§€ê¸ˆ ë°”ë¡œ í¬ìŠ¤íŒ…';
         } else if (interval === 'disabled') {
             buttonText.textContent = 'âš ï¸ ë°˜ë³µ ì•ˆ í•¨ (ìˆ˜ë™)'; // Or maybe disable the button?
         } else {
             buttonText.textContent = 'ğŸ”„ ë°˜ë³µ í¬ìŠ¤íŒ… ì‹œì‘/ì—…ë°ì´íŠ¸';
         }
     }

    async function submit() {
      const keywordInput = document.getElementById('keyword');
      const contentInput = document.getElementById('content');
      const resultMessage = document.getElementById('resultMessage');
      const imageStrategy = document.querySelector('input[name="imageStrategy"]:checked')?.value || 'none';
      const contentStrategy = document.querySelector('input[name="contentStrategy"]:checked')?.value || 'ai_only';
      const scheduleInterval = document.getElementById('scheduleInterval').value;
      const targetPlatform = document.querySelector('input[name="targetPlatform"]:checked')?.value || 'wordpress';
      const linkKeywordCheckbox = document.getElementById('linkKeywordCheckbox');
      const keywordLinkUrlInput = document.getElementById('keywordLinkUrlInput');
      const contentToneSelect = document.getElementById('contentTone');
      const requiredPhrasesInput = document.getElementById('requiredPhrases');

      const submitButton = document.getElementById('submitButton');
      const buttonText = document.getElementById('buttonText');
      const loadingSpinner = document.getElementById('loadingSpinner');

      // --- Authentication Check ---
      const token = localStorage.getItem('authToken');
      if (!token) {
        resultMessage.textContent = 'ì˜¤ë¥˜: ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        submitButton.disabled = false; // Re-enable button
        return;
      }

      // --- UI Update Start ---
      submitButton.disabled = true;
      buttonText.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');
      resultMessage.textContent = '';

      try {
        // --- Validation ---
        if (imageStrategy === 'manual' && manuallyUploadedFiles.length === 0) {
          throw new Error('"ì§ì ‘ ì˜¬ë¦° íŒŒì¼ ì‚¬ìš©"ì„ ì„ íƒí–ˆì§€ë§Œ íŒŒì¼ì´ ì²¨ë¶€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        const keywordValue = keywordInput.value.trim();
        const requiresKeyword = contentStrategy === 'ai_only' || contentStrategy === 'mix' || imageStrategy === 'ai' || imageStrategy === 'unsplash';
        if (requiresKeyword && !keywordValue) {
          throw new Error('AI ë˜ëŠ” ì´ë¯¸ì§€ ê²€ìƒ‰/ìƒì„± ë°©ì‹ì„ ì‚¬ìš©í•˜ë ¤ë©´ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
        }
         if (scheduleInterval === 'disabled' && contentStrategy === 'ai_only') {
             // Maybe allow this? Or maybe warn? For now, allow.
         }

        resultMessage.textContent = scheduleInterval === 'now' ? 'í¬ìŠ¤íŒ… ìƒì„± ì¤‘...' : 'ë°˜ë³µ í¬ìŠ¤íŒ… ì„¤ì • ì¤‘...';

        // --- Prepare Data ---
        const formData = new FormData();
        // Split keywords, trim, filter empty ones
        const keywords = keywordValue.split(',').map(k => k.trim()).filter(k => k);
        formData.append('keywords', JSON.stringify(keywords)); // Send keywords as JSON string array
        formData.append('content', contentInput.value);
        formData.append('contentStrategy', contentStrategy);
        formData.append('imageStrategy', imageStrategy);
        formData.append('contentTone', contentToneSelect.value);
        formData.append('targetPlatform', targetPlatform);
        formData.append('scheduleInterval', scheduleInterval); // Send the selected interval value
        // Required phrases
        const phrases = requiredPhrasesInput.value.split(',').map(p => p.trim()).filter(p => p);
        formData.append('requiredPhrases', JSON.stringify(phrases)); // Send as JSON string array

        if (linkKeywordCheckbox.checked && keywordLinkUrlInput.value) {
          formData.append('linkKeyword', 'true');
          formData.append('keywordLinkUrl', keywordLinkUrlInput.value);
        } else {
          formData.append('linkKeyword', 'false');
        }
        if (imageStrategy === 'manual' && manuallyUploadedFiles.length > 0) {
          manuallyUploadedFiles.forEach(file => formData.append('files', file, file.name));
        }

        // --- API Call ---
        // Determine endpoint based on schedule choice
        const apiUrl = scheduleInterval === 'now' ? '/api/post' : '/api/user/schedule'; // Use different endpoints
        const apiMethod = scheduleInterval === 'now' ? 'POST' : 'POST'; // POST for schedule creation/update too

        const res = await fetch(apiUrl, {
          method: apiMethod,
          headers: { 'Authorization': `Bearer ${token}` }, // No Content-Type for FormData
          body: formData
        });

        if (!res.ok) {
            let errorMsg = `HTTP error! status: ${res.status}`;
             try {
                 const errorData = await res.json();
                 if (res.status === 401) { errorMsg = 'ì¸ì¦ ì‹¤íŒ¨: ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; }
                 else { errorMsg += ` - ${errorData.message || JSON.stringify(errorData)}`; }
             } catch (e) { /* Ignore */ }
             throw new Error(errorMsg);
         }

      const data = await res.json();

         if (data.success) {
             resultMessage.textContent = data.message || (scheduleInterval === 'now' ? 'âœ… í¬ìŠ¤íŒ… ìƒì„± ìš”ì²­ ì„±ê³µ!' : 'âœ… ë°˜ë³µ í¬ìŠ¤íŒ… ì„¤ì • ì™„ë£Œ!');
             // Reset form for immediate post, but not for schedule setup?
             if (scheduleInterval === 'now') {
                 // keywordInput.value = ''; // Maybe don't clear keyword?
                 contentInput.value = '';
                 clearPreview();
             }
         } else {
             throw new Error(data.message || 'ì„œë²„ì—ì„œ ìš”ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
         }

      } catch (error) {
        console.error('Error submitting:', error);
        resultMessage.textContent = `ì˜¤ë¥˜: ${error.message}`;
      } finally {
        // --- UI Update End ---
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
      }
    }

    // Load settings when the page loads
    document.addEventListener('DOMContentLoaded', loadUserSettings);

  </script>
</body>
</html>

